<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Deck power visualization tool, built by mlibna@reddit</title>
</head>

<body style="background-color:powderblue;">
  <script type="text/javascript" src="scores.json"></script>
  <script type="text/javascript" src="traits.json"></script>
  <script>
    var my_deck = [
        'bending-school',
        'bill-dauterive',
        'bill-dauterive',
        'bill-dauterive',
        'bobby',
        'dr-amy-wong',
        'dr-banjo',
        'dr-cahill',
        'mythic-dr-zoidberg',
        'eugene-belcher',
        'hank-hill',
        'hank-hill',
        'horse-camp',
        'leon-petard',
        'leon-petard',
        'peter',
        'peter',
        'professor-lerner',
        'quahog-martial-arts-academy',
        'quahog-preschool',
        'student-lucky',
        'stuffington-academy',
        'tom-landry-middle-school',
    ];
    var rare_chs = [
        'bill', 'gene', 'hayley', 'hermes', 'klaus', 'luanns', 'meg', 'professor-farnsworth', 'quagmire', 'teddy',    
    ];
    var common_chs = [
        'bullock', 'chris', 'dale', 'dr-zoidberg', 'fry', 'hank', 'linda', 'lois', 'mort', 'stevs',    
    ];
    var epic_chs = [
        'amy', 'bob', 'boomhauer', 'brian', 'francine', 'leela', 'louise', 'peggy', 'stan', 'stewie',     
    ];
    var chs = [
        'bullock', 'chris', 'dale', 'dr-zoidberg', 'fry', 'hank', 'linda', 'lois', 'mort', 'stevs',    
        'bill', 'gene', 'hayley', 'hermes', 'klaus', 'luanns', 'meg', 'professor-farnsworth', 'quagmire', 'teddy',    
        'amy', 'bob', 'boomhauer', 'brian', 'francine', 'leela', 'louise', 'peggy', 'stan', 'stewie',     
        'bill-dauterive',
        'philip-j-fry',
        'dr-amy-wong',
        'eugene-belcher',
        'chris-griffin',
        'meg-griffin',
        'hank-hill',
        'bender',
        'steve-smith',
        'peter',
        'roger',
        'tina',
        'linda-belcher',
        'klaus-heisler',
        'bobby',
        'francine-smith',
        'lois-griffin',
        'hermes-conrad',
        'mythic-stewie',
        'mythic-quagmire',
        'mythic-brian',
        'mythic-stan',
        'mythic-bullock',
        'mythic-hayley',
        'mythic-louise',
        'mythic-bob',
        'mythic-teddy',
        'mythic-peggy',
        'mythic-boomhauer',
        'mythic-dale',
        'mythic-leela',
        'mythic-dr-zoidberg',
        'mythic-professor-farnsworth',
        'mythic-bender',
        'mythic-bobby',
        'mythic-peter',
        'mythic-tina',
        'lvl0-mythic-bender',
        'lvl0-mythic-bobby',
        'lvl0-mythic-peter',
        'lvl0-mythic-tina',
        ];
    var is_char = function(card){
      for (var i = 0; i < chs.length; i++){
        if (chs[i] == card) { return true; }
      }
      return false;
    };
    var bge_img_tag = function(it){
        bge = traits[it];
        return '<img src="img/icon_large_' + bge + '.png" style="max-width:100%;max-height:100%;height:20px;width:20px;">';
    };
    var rarity_img_tag = function(ch){
        rarity = 'legendary';
        if (ch.substring(0, 6) == 'mythic') {rarity = 'mythic';}
        for (var i = 0; i < epic_chs.length; i++){
            if (epic_chs[i] == ch) {rarity = 'epic';}
        }
        for (var i = 0; i < rare_chs.length; i++){
            if (rare_chs[i] == ch) {rarity = 'rare';}
        }
        for (var i = 0; i < common_chs.length; i++){
            if (common_chs[i] == ch) {rarity = 'common';}
        }
        return '<img src="img/rarityicon_' + rarity + '.png" style="max-width:100%;max-height:100%;height:20px;width:20px;">';
    };
    var mydata = JSON.parse(data);
    var traits = JSON.parse(tr_data);
    var make_table = function(chs, its){
      var h = '<table style="width:100%"><tr><th></th>';
      its.forEach(
          function(it){
            h += '<th>' + bge_img_tag(it) + it + '</th>';
          }
        );
      h += '</tr>';
      chs.forEach(
          function(ch){
            h += '<tr><td>' + rarity_img_tag(ch) + ch + '</td>';
            its.forEach(
                function(it){
                  var power = 0;
                  var color = '255';
                  if ((ch + '+' + it) in mydata){
                    power = (Math.round(mydata[ch + '+' + it]*100)/100);
                    if (power > 5) { power = 5; }
                    color = Math.round(255 - power*power/25*255).toString();
                  }
                  h += '<td style="background-color:rgb(255,' + color + ',' + color + ');">' + power.toString() + '</td>';
                }
              );
            h += '</tr>';
          }
        );
      h += '</table>';
      return h;
    };
    function getRandomSubarray(arr, size) {
        var shuffled = arr.slice(0), i = arr.length, temp, index;
        while (i--) {
            index = Math.floor((i + 1) * Math.random());
            temp = shuffled[index];
            shuffled[index] = shuffled[i];
            shuffled[i] = temp;
        }
        return shuffled.slice(0, size);
    }
    var best_combo = function(clist = document.getElementById('card-list-input').value.split(',')){
        while (clist.length < 25) {clist.push('XXX');}
        var best_scores = [];
        var total_times = 50000;
        for (var time = 0; time < total_times; time ++){
            var draw = getRandomSubarray(clist, 5);
            var best_combo;
            var best_score = 0.0;
            for (var i = 0; i < 5; i++){
                for (var j = 0; j < 5; j++){
                    var combo = draw[i] + '+' + draw[j];
                    if (mydata[combo] > best_score){
                        best_combo = combo;
                        best_score = mydata[combo];
                    }
                }
            }
            best_scores.push(best_score);
        }
        var dict = {};
        dict[0] = [];
        for (var i = 0; i < clist.length; i++){
            for (var j = 0; j < clist.length; j++){
                var combo = clist[i] + '+' + clist[j];
                dict[mydata[combo]] = [];
            }
        }
        for (var i = 0; i < clist.length; i++){
            for (var j = 0; j < clist.length; j++){
                var combo = clist[i] + '+' + clist[j];
                var present = false;
                if (!(combo in mydata)) continue;
                for (var k = 0; k < dict[mydata[combo]].length; k++){
                    if (dict[mydata[combo]][k] == combo) {
                        present = true;
                        //console.log(combo);
                        //console.log(dict[mydata[combo]]);
                    }
                }
                if (!present){
                    dict[mydata[combo]].push(combo);
                }
            }
        }
        best_scores.sort();
        var h = '<table style="border-style:solid;"><tr><th colspan="3">Chance of making a combo stronger than ...</th></tr>';
        var rows = 20;
        for (var i = 2; i < rows; i++){
            h += '<tr><td style="border-right:solid 1px black;">' + ((rows-i)*100/rows).toString() + '%</td>';
            var cs = best_scores[total_times/rows*i];
            h += '<td>' + (Math.round(cs*100)/100).toString() + '</td><td>';
            for (var j = 0; j < dict[cs].length; j++){
                h += dict[cs][j] + ' ';
            }
            h += '</td></th>';
        }
        h += '</table>';
        document.getElementById('best-combo').innerHTML = h;
    };
    var go = function(clist = document.getElementById('card-list-input').value.split(',')){
      var chs = [];
      var its = [];
      clist.forEach(
          function(cd){
            if (is_char(cd)) {chs.push(cd);}
            else {its.push(cd);}
          }
        );
      var h = make_table(chs, its);
      //console.log(chs);
      //console.log(its);
      //console.log(h);
      document.getElementById('table').innerHTML = h;
      best_combo(clist);
    };
  </script>
  <form>
    Card list (separated by comma):
    <input type="text" id="card-list-input" style="width:100%;">
  </form>
  <div>
  <br>
  <b>
  Example: copy and paste the following and click GO!
  </b>
  </br>
  <div style="border-style:solid;">
  dr-amy-wong,hank-hill,bobby,mythic-dr-zoidberg,eugene-belcher,leon-petard,hypnotoad,student-lucky,book-of-spells,iraq-lobster
  </div>
  </div>
  <button type="button" onclick="console.log('go!');go()">GO!</button>
  <div id = "best-combo" style="border-style:solid;">
  </div>
  <div id = "table" style="border-style:solid;">
  </div>
</body>
</html>
